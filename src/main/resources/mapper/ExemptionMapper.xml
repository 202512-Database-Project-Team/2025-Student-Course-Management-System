<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.auggie.student_server.mapper.ExemptionMapper">

    <insert id="save" parameterType="Exemption">
        INSERT INTO apply_exemption (sid, cid, term, reason, proof, status)
        VALUES (#{exemption.sid}, #{exemption.cid}, #{exemption.term}, #{exemption.reason}, #{exemption.proof}, 0)
    </insert>

    <select id="findBySid" resultType="Exemption">
        SELECT 
            e.*, 
            c.cname as cname
        FROM apply_exemption e
        LEFT JOIN c ON e.cid = c.cid
        WHERE e.sid = #{sid}
        ORDER BY e.create_time DESC
    </select>

    <select id="findPending" resultType="Exemption">
        SELECT 
            e.*, 
            s.sname as sname,
            c.cname as cname
        FROM apply_exemption e
        LEFT JOIN s ON e.sid = s.sid
        LEFT JOIN c ON e.cid = c.cid
        WHERE e.status = 0
    </select>

    <update id="updateStatus" parameterType="Exemption">
        UPDATE apply_exemption
        SET status = #{exemption.status},
            audit_reason = #{exemption.auditReason},
            audit_by = #{exemption.auditBy},
            audit_time = NOW()
        WHERE id = #{exemption.id}
    </update>

    <select id="findBySidCidTerm" resultType="Exemption">
        SELECT * FROM apply_exemption
        WHERE sid = #{sid}
          AND cid = #{cid}
          AND term = #{term}
            LIMIT 1
    </select>

</mapper>